<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üìã View Expenses - Finance Tracker</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="logo">üí∞ Finance Tracker</h1>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="add-expense.html">Add Expense</a></li>
                    <li><a href="add-income.html">Add Income</a></li>
                    <li>
                        <a href="expenses.html" class="active">View Expenses</a>
                    </li>
                    <li><a href="income.html">View Income</a></li>
                    <li><a href="logs.html">Logs</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container">
            <div class="page-header">
                <h2>üìã All Expenses</h2>
                <p>View and manage all your recorded expenses</p>
            </div>

            <!-- Summary Stats -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="card-icon">üí∏</div>
                    <div class="card-content">
                        <h3>Total Expenses</h3>
                        <p class="amount" id="totalExpenses">AED 0.00</p>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="card-icon">üìä</div>
                    <div class="card-content">
                        <h3>Total Records</h3>
                        <p class="amount" id="totalRecords">0</p>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="card-icon">üìà</div>
                    <div class="card-content">
                        <h3>Average Expense</h3>
                        <p class="amount" id="avgExpense">AED 0.00</p>
                    </div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div class="actions-bar">
                <a href="add-expense.html" class="btn btn-danger"
                    >‚ûï Add New Expense</a
                >
                <button onclick="loadExpenses()" class="btn btn-secondary">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Expenses Table -->
            <div class="section-card">
                <h3>üìù Expense List</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody">
                            <tr>
                                <td colspan="5" class="loading-text">
                                    Loading expenses...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Status Message -->
            <div
                id="statusMessage"
                class="status-message"
                style="display: none"
            ></div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Finance Tracker - OOP Project | BITS Pilani</p>
            <div
                style="
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    font-size: 0.9em;
                "
            >
                <p style="margin: 5px 0">
                    <strong>OOP Group Project - 2025-2026</strong>
                </p>
                <p style="margin: 5px 0"><strong>Team Members:</strong></p>
                <p style="margin: 3px 0">
                    Harshwardhan Mohadikar - 2024ADPS0004U
                </p>
                <p style="margin: 3px 0">Adhya Varshney - 2024A7PS0197U</p>
                <p style="margin: 3px 0">Daksh Dawra - 2024A7PS0264U</p>
                <p style="margin: 3px 0">Anirudh Jain - 2024A7PS0171U</p>
                <p style="margin: 3px 0">Anish Malhotra - 2024A7PS0226U</p>
                <p style="margin: 3px 0">Vardhaman Jain - 2024A7PS0229U</p>
            </div>
        </footer>

        <script>
            // CHANGE THIS to your Render.com backend URL
            const API_URL = "http://localhost:8080";

            // Load expenses on page load
            window.addEventListener("DOMContentLoaded", function () {
                loadExpenses();
            });

            // Function to load all expenses
            function loadExpenses() {
                const tbody = document.getElementById("expensesBody");
                tbody.innerHTML =
                    '<tr><td colspan="5" class="loading-text">Loading expenses...</td></tr>';

                fetch(API_URL + "/api/expenses")
                    .then((response) => response.json())
                    .then((expenses) => {
                        if (!expenses || expenses.length === 0) {
                            tbody.innerHTML =
                                '<tr><td colspan="5" class="empty-text">No expenses found. <a href="add-expense.html">Add your first expense</a></td></tr>';
                            updateSummary([], 0, 0);
                            return;
                        }

                        // Sort expenses by date (newest first)
                        expenses.sort(
                            (a, b) => new Date(b.date) - new Date(a.date),
                        );

                        // Calculate statistics
                        const totalExpenseAmount = expenses.reduce(
                            (sum, exp) => sum + exp.amount,
                            0,
                        );
                        const avgExpenseAmount =
                            totalExpenseAmount / expenses.length;

                        updateSummary(
                            expenses,
                            totalExpenseAmount,
                            avgExpenseAmount,
                        );

                        // Build table rows
                        let html = "";
                        expenses.forEach((expense) => {
                            html += `
                            <tr>
                                <td>${expense.date}</td>
                                <td>${expense.category}</td>
                                <td>${expense.description}</td>
                                <td class="amount-cell">AED ${expense.amount.toFixed(2)}</td>
                                <td>
                                    <button onclick="deleteExpense('${expense.id}')" class="btn-delete">
                                        üóëÔ∏è Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                        });
                        tbody.innerHTML = html;
                    })
                    .catch((error) => {
                        console.error("Error loading expenses:", error);
                        tbody.innerHTML =
                            '<tr><td colspan="5" class="error-text">Failed to load expenses. Please try again.</td></tr>';
                    });
            }

            // Function to update summary statistics
            function updateSummary(expenses, total, average) {
                document.getElementById("totalExpenses").textContent =
                    "AED " + total.toFixed(2);
                document.getElementById("totalRecords").textContent =
                    expenses.length;
                document.getElementById("avgExpense").textContent =
                    "AED " + average.toFixed(2);
            }

            // Function to delete expense
            function deleteExpense(id) {
                if (!confirm("Are you sure you want to delete this expense?")) {
                    return;
                }

                const statusMessage = document.getElementById("statusMessage");
                statusMessage.style.display = "block";
                statusMessage.className = "status-message info-message";
                statusMessage.textContent = "‚è≥ Deleting expense...";

                fetch(API_URL + "/api/expenses/" + id, {
                    method: "DELETE",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            statusMessage.className =
                                "status-message success-message";
                            statusMessage.textContent =
                                "‚úÖ Expense deleted successfully!";

                            // Reload expenses
                            setTimeout(() => {
                                loadExpenses();
                                statusMessage.style.display = "none";
                            }, 2000);
                        } else {
                            throw new Error(
                                data.message || "Failed to delete expense",
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        statusMessage.className =
                            "status-message error-message";
                        statusMessage.textContent =
                            "‚ùå Error: " + error.message;
                    });
            }
        </script>
    </body>
</html>
