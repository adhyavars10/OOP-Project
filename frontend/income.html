<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>üíµ View Income - Finance Tracker</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="nav-container">
                <h1 class="logo">üí∞ Finance Tracker</h1>
                <ul class="nav-links">
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="add-expense.html">Add Expense</a></li>
                    <li><a href="add-income.html">Add Income</a></li>
                    <li><a href="expenses.html">View Expenses</a></li>
                    <li>
                        <a href="income.html" class="active">View Income</a>
                    </li>
                    <li><a href="logs.html">Logs</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container">
            <div class="page-header">
                <h2>üíµ All Income</h2>
                <p>View and manage all your recorded income</p>
            </div>

            <!-- Summary Stats -->
            <div class="summary-grid">
                <div class="summary-card income-card">
                    <div class="card-icon">üí∞</div>
                    <div class="card-content">
                        <h3>Total Income</h3>
                        <p class="amount" id="totalIncome">AED 0.00</p>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="card-icon">üìä</div>
                    <div class="card-content">
                        <h3>Total Records</h3>
                        <p class="amount" id="totalRecords">0</p>
                    </div>
                </div>

                <div class="summary-card">
                    <div class="card-icon">üìà</div>
                    <div class="card-content">
                        <h3>Average Income</h3>
                        <p class="amount" id="avgIncome">AED 0.00</p>
                    </div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div class="actions-bar">
                <a href="add-income.html" class="btn btn-success"
                    >‚ûï Add New Income</a
                >
                <button onclick="loadIncome()" class="btn btn-secondary">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Income Table -->
            <div class="section-card">
                <h3>üìù Income List</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Source</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="incomeBody">
                            <tr>
                                <td colspan="5" class="loading-text">
                                    Loading income records...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Status Message -->
            <div
                id="statusMessage"
                class="status-message"
                style="display: none"
            ></div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Finance Tracker - OOP Project | BITS Pilani</p>
            <div
                style="
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    font-size: 0.9em;
                "
            >
                <p style="margin: 5px 0">
                    <strong>OOP Group Project - 2025-2026</strong>
                </p>
                <p style="margin: 5px 0"><strong>Team Members:</strong></p>
                <p style="margin: 3px 0">
                    Harshwardhan Mohadikar - 2024ADPS0004U
                </p>
                <p style="margin: 3px 0">Adhya Varshney - 2024A7PS0197U</p>
                <p style="margin: 3px 0">Daksh Dawra - 2024A7PS0264U</p>
                <p style="margin: 3px 0">Anirudh Jain - 2024A7PS0171U</p>
                <p style="margin: 3px 0">Anish Malhotra - 2024A7PS0226U</p>
                <p style="margin: 3px 0">Vardhaman Jain - 2024A7PS0229U</p>
            </div>
        </footer>

        <script>
            // CHANGE THIS to your Render.com backend URL
            const API_URL = "http://localhost:8080";

            // Load income on page load
            window.addEventListener("DOMContentLoaded", function () {
                loadIncome();
            });

            // Function to load all income
            function loadIncome() {
                const tbody = document.getElementById("incomeBody");
                tbody.innerHTML =
                    '<tr><td colspan="5" class="loading-text">Loading income records...</td></tr>';

                fetch(API_URL + "/api/income")
                    .then((response) => response.json())
                    .then((incomeList) => {
                        if (!incomeList || incomeList.length === 0) {
                            tbody.innerHTML =
                                '<tr><td colspan="5" class="empty-text">No income records found. <a href="add-income.html">Add your first income</a></td></tr>';
                            updateSummary([], 0, 0);
                            return;
                        }

                        // Sort income by date (newest first)
                        incomeList.sort(
                            (a, b) => new Date(b.date) - new Date(a.date),
                        );

                        // Calculate statistics
                        const totalIncomeAmount = incomeList.reduce(
                            (sum, income) => sum + income.amount,
                            0,
                        );
                        const avgIncomeAmount =
                            totalIncomeAmount / incomeList.length;

                        updateSummary(
                            incomeList,
                            totalIncomeAmount,
                            avgIncomeAmount,
                        );

                        // Build table rows
                        let html = "";
                        incomeList.forEach((income) => {
                            html += `
                            <tr>
                                <td>${income.date}</td>
                                <td>üíº ${income.source}</td>
                                <td>${income.description}</td>
                                <td class="amount-cell income-amount">AED ${income.amount.toFixed(2)}</td>
                                <td>
                                    <button onclick="deleteIncome('${income.id}')" class="btn-delete">
                                        üóëÔ∏è Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                        });
                        tbody.innerHTML = html;
                    })
                    .catch((error) => {
                        console.error("Error loading income:", error);
                        tbody.innerHTML =
                            '<tr><td colspan="5" class="error-text">Failed to load income records. Please try again.</td></tr>';
                    });
            }

            // Function to update summary statistics
            function updateSummary(incomeList, total, average) {
                document.getElementById("totalIncome").textContent =
                    "AED " + total.toFixed(2);
                document.getElementById("totalRecords").textContent =
                    incomeList.length;
                document.getElementById("avgIncome").textContent =
                    "AED " + average.toFixed(2);
            }

            // Function to delete income
            function deleteIncome(id) {
                if (
                    !confirm(
                        "Are you sure you want to delete this income record?",
                    )
                ) {
                    return;
                }

                const statusMessage = document.getElementById("statusMessage");
                statusMessage.style.display = "block";
                statusMessage.className = "status-message info-message";
                statusMessage.textContent = "‚è≥ Deleting income...";

                fetch(API_URL + "/api/income/" + id, {
                    method: "DELETE",
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            statusMessage.className =
                                "status-message success-message";
                            statusMessage.textContent =
                                "‚úÖ Income deleted successfully!";

                            // Reload income
                            setTimeout(() => {
                                loadIncome();
                                statusMessage.style.display = "none";
                            }, 2000);
                        } else {
                            throw new Error(
                                data.message || "Failed to delete income",
                            );
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        statusMessage.className =
                            "status-message error-message";
                        statusMessage.textContent =
                            "‚ùå Error: " + error.message;
                    });
            }
        </script>
    </body>
</html>
